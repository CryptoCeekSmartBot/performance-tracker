<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Performance Tracker Pro v2.0 | Corporate Analytics Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    .light-mode::-webkit-scrollbar-track { background: #e2e8f0; }
    .light-mode::-webkit-scrollbar-thumb { background: #94a3b8; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
    .animate-pulse-slow { animation: pulse 2s ease-in-out infinite; }
    .gradient-text { background: linear-gradient(135deg, #06b6d4, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .cell-green { background: linear-gradient(135deg, #059669, #10b981); }
    .cell-yellow { background: linear-gradient(135deg, #d97706, #f59e0b); }
    .cell-red { background: linear-gradient(135deg, #dc2626, #ef4444); }
    .cell-holiday { background: linear-gradient(135deg, #475569, #64748b); }
    .glass { backdrop-filter: blur(10px); }
    .modal-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
    .tab-active { border-bottom: 2px solid #06b6d4; color: #06b6d4; }
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; color: black !important; }
      .print-break { page-break-before: always; }
    }
  </style>
</head>
<body class="bg-slate-950 text-gray-100 min-h-screen">
  <div id="app">
    <!-- Upload Screen -->
    <div id="upload-screen" class="min-h-screen flex items-center justify-center p-4">
      <div class="max-w-3xl w-full animate-fade-in">
        <div class="text-center mb-8">
          <h1 class="text-4xl md:text-5xl font-bold gradient-text mb-3">Performance Tracker Pro</h1>
          <p class="text-gray-400 text-lg">Corporate Employee Performance Analytics v2.0</p>
        </div>
        
        <!-- Report Type Selection -->
        <div class="flex justify-center gap-4 mb-6">
          <button id="mtd-mode-btn" class="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 rounded-xl text-sm font-medium transition-all">
            ğŸ“Š MTD Report (Single Month)
          </button>
          <button id="ytd-mode-btn" class="px-6 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl text-sm font-medium transition-all">
            ğŸ“ˆ YTD Report (Multi Month)
          </button>
        </div>
        
        <!-- MTD Upload Zone -->
        <div id="mtd-upload-zone" class="bg-slate-900 border-2 border-dashed border-slate-700 rounded-2xl p-12 text-center cursor-pointer transition-all duration-300 hover:border-cyan-500 hover:bg-cyan-500/5">
          <div class="mb-6">
            <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center mb-4 shadow-lg shadow-cyan-500/25">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">Drop Excel File Here</h3>
            <p class="text-gray-400">or click to browse (Single month file)</p>
          </div>
          <input type="file" id="file-input" accept=".xls,.xlsx" class="hidden">
          <div class="flex items-center justify-center gap-2 text-gray-500 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            Supports .xls and .xlsx files
          </div>
        </div>
        
        <!-- YTD Upload Zone (Hidden by default) -->
        <div id="ytd-upload-zone" class="hidden bg-slate-900 border-2 border-dashed border-slate-700 rounded-2xl p-12 text-center cursor-pointer transition-all duration-300 hover:border-cyan-500 hover:bg-cyan-500/5">
          <div class="mb-6">
            <div class="w-20 h-20 mx-auto rounded-2xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center mb-4 shadow-lg shadow-purple-500/25">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </div>
            <h3 class="text-xl font-semibold text-white mb-2">Drop Multiple Excel Files</h3>
            <p class="text-gray-400">Select all months (Jan, Feb, Mar... up to 12 files)</p>
          </div>
          <input type="file" id="ytd-file-input" accept=".xls,.xlsx" multiple class="hidden">
          <div id="ytd-files-list" class="hidden mt-4 text-left bg-slate-800 rounded-lg p-4 max-h-40 overflow-y-auto"></div>
          <button id="process-ytd-btn" class="hidden mt-4 px-6 py-2 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm font-medium">
            ğŸ“Š Process YTD Report
          </button>
        </div>
        
        <!-- Settings Buttons -->
        <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3">
          <button id="manage-holidays-btn-upload" class="px-4 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl text-sm font-medium transition-all">
            ğŸ“… Holidays
          </button>
          <button id="manage-joiners-btn-upload" class="px-4 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl text-sm font-medium transition-all">
            ğŸ†• New Joiners
          </button>
          <button id="manage-resigned-btn-upload" class="px-4 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl text-sm font-medium transition-all">
            ğŸšª Resigned
          </button>
          <button id="settings-btn-upload" class="px-4 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl text-sm font-medium transition-all">
            âš™ï¸ Import/Export
          </button>
        </div>
        
        <p class="text-gray-500 text-xs mt-3 text-center">Sundays auto-excluded â€¢ Holidays configurable â€¢ New Joiners/Resigned tracked</p>
        
        <div class="mt-8 grid grid-cols-4 gap-4 text-center">
          <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
            <div class="text-2xl mb-2">ğŸ“Š</div>
            <div class="text-xs text-gray-400">Real-time Analytics</div>
          </div>
          <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
            <div class="text-2xl mb-2">ğŸ¯</div>
            <div class="text-xs text-gray-400">Target Tracking</div>
          </div>
          <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
            <div class="text-2xl mb-2">ğŸ“…</div>
            <div class="text-xs text-gray-400">Holiday Manager</div>
          </div>
          <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
            <div class="text-2xl mb-2">ğŸ“ˆ</div>
            <div class="text-xs text-gray-400">YTD Reports</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
      <!-- Header -->
      <header class="bg-slate-900/95 border-b border-slate-800 sticky top-0 z-40 glass no-print">
        <div class="max-w-[1920px] mx-auto px-4 py-3">
          <!-- Row 1: Title and badges -->
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3 mb-3">
            <div class="flex items-center gap-3 flex-wrap">
              <h1 class="text-xl font-bold gradient-text">Performance Tracker Pro</h1>
              <span id="report-type-badge" class="px-3 py-1 rounded-full text-xs font-medium bg-cyan-900/50 text-cyan-400">MTD</span>
              <span id="report-date-badge" class="px-3 py-1 rounded-full text-xs font-medium bg-slate-800 text-gray-300"></span>
              <span id="working-days-badge" class="px-3 py-1 rounded-full text-xs font-medium bg-emerald-900/50 text-emerald-400"></span>
            </div>
            
            <div class="flex flex-wrap items-center gap-2">
              <button id="download-pdf-btn" class="px-3 py-2 rounded-lg bg-red-600 hover:bg-red-500 text-sm font-medium" title="Download PDF">ğŸ“„ PDF</button>
              <button id="download-excel-btn" class="px-3 py-2 rounded-lg bg-green-600 hover:bg-green-500 text-sm font-medium" title="Download Excel">ğŸ“Š Excel</button>
              <button id="manage-holidays-btn" class="px-3 py-2 rounded-lg hover:bg-slate-800 border border-slate-700 text-sm" title="Manage Holidays">ğŸ“…</button>
              <button id="manage-joiners-btn" class="px-3 py-2 rounded-lg hover:bg-slate-800 border border-slate-700 text-sm" title="New Joiners">ğŸ†•</button>
              <button id="manage-resigned-btn" class="px-3 py-2 rounded-lg hover:bg-slate-800 border border-slate-700 text-sm" title="Resigned">ğŸšª</button>
              <button id="settings-btn" class="px-3 py-2 rounded-lg hover:bg-slate-800 border border-slate-700 text-sm" title="Settings">âš™ï¸</button>
              <button id="theme-toggle" class="p-2 rounded-lg hover:bg-slate-800 border border-slate-700" title="Toggle theme">â˜€ï¸</button>
              <button id="fullscreen-toggle" class="p-2 rounded-lg hover:bg-slate-800 border border-slate-700" title="Fullscreen">â›¶</button>
              <button id="print-btn" class="p-2 rounded-lg hover:bg-slate-800 border border-slate-700" title="Print">ğŸ–¨ï¸</button>
              <button id="new-upload-btn" class="p-2 rounded-lg hover:bg-slate-800 border border-slate-700" title="New Upload">ğŸ“¤</button>
            </div>
          </div>
          
          <!-- Row 2: Filters and Controls -->
          <div class="flex flex-wrap items-center gap-3">
            <!-- Search -->
            <div class="relative">
              <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <input type="text" id="search-input" placeholder="Search employee..." class="bg-slate-800 border border-slate-700 text-gray-100 pl-10 pr-4 py-2 rounded-lg text-sm w-40 focus:outline-none focus:ring-2 focus:ring-cyan-500">
            </div>
            
            <!-- Status Filter -->
            <select id="filter-select" class="bg-slate-800 border border-slate-700 text-gray-100 px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500">
              <option value="all">All Status</option>
              <option value="ontrack">âœ… On Track</option>
              <option value="atrisk">âš ï¸ At Risk</option>
              <option value="critical">ğŸ”´ Critical</option>
              <option value="star">â­ Stars</option>
              <option value="newjoiners">ğŸ†• New Joiners</option>
              <option value="resigned">ğŸšª Resigned</option>
            </select>
            
            <!-- Sort By -->
            <select id="sort-select" class="bg-slate-800 border border-slate-700 text-gray-100 px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500">
              <option value="name-asc">Name (A-Z)</option>
              <option value="name-desc">Name (Z-A)</option>
              <option value="achievement-desc">Achievement % (Highâ†’Low)</option>
              <option value="achievement-asc">Achievement % (Lowâ†’High)</option>
              <option value="output-desc">Total Output (Highâ†’Low)</option>
              <option value="output-asc">Total Output (Lowâ†’High)</option>
              <option value="shortfall-desc">Shortfall (Highâ†’Low)</option>
              <option value="shortfall-asc">Shortfall (Lowâ†’High)</option>
            </select>
            
            <!-- Date Range -->
            <div class="flex items-center gap-2 bg-slate-800 border border-slate-700 rounded-lg px-3 py-1">
              <span class="text-xs text-gray-400">From:</span>
              <input type="date" id="date-from" class="bg-transparent text-gray-100 text-sm focus:outline-none w-32">
              <span class="text-xs text-gray-400">To:</span>
              <input type="date" id="date-to" class="bg-transparent text-gray-100 text-sm focus:outline-none w-32">
              <button id="apply-date-filter" class="px-2 py-1 bg-cyan-600 hover:bg-cyan-500 rounded text-xs font-medium">Apply</button>
              <button id="clear-date-filter" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs font-medium">Clear</button>
            </div>
          </div>
        </div>
      </header>

      <main class="max-w-[1920px] mx-auto p-4 space-y-6">
        <!-- Summary Cards -->
        <div id="summary-cards" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3"></div>

        <!-- Champion & Leaderboard -->
        <div class="grid lg:grid-cols-3 gap-4">
          <div id="champion-card" class="bg-gradient-to-br from-amber-900/30 to-yellow-900/20 border border-slate-800 rounded-xl p-6"></div>
          <div id="leaderboard-card" class="bg-slate-900 border border-slate-800 rounded-xl p-4 lg:col-span-2"></div>
        </div>

        <!-- Color Legend -->
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
          <div class="flex flex-wrap items-center gap-4 justify-center text-sm">
            <div class="flex items-center gap-2">
              <span class="font-semibold text-xs">Target 8:</span>
              <div class="flex items-center gap-1"><div class="w-4 h-4 rounded cell-green"></div><span class="text-xs">â‰¥8</span></div>
              <div class="flex items-center gap-1"><div class="w-4 h-4 rounded cell-yellow"></div><span class="text-xs">6-7</span></div>
              <div class="flex items-center gap-1"><div class="w-4 h-4 rounded cell-red"></div><span class="text-xs">&lt;6</span></div>
            </div>
            <div class="w-px h-6 bg-slate-700"></div>
            <div class="flex items-center gap-2">
              <span class="font-semibold text-xs">Target 10:</span>
              <div class="flex items-center gap-1"><div class="w-4 h-4 rounded cell-green"></div><span class="text-xs">â‰¥10</span></div>
              <div class="flex items-center gap-1"><div class="w-4 h-4 rounded cell-yellow"></div><span class="text-xs">8-9</span></div>
              <div class="flex items-center gap-1"><div class="w-4 h-4 rounded cell-red"></div><span class="text-xs">&lt;8</span></div>
            </div>
            <div class="w-px h-6 bg-slate-700"></div>
            <div class="flex items-center gap-2">
              <div class="flex items-center gap-1"><div class="w-4 h-4 rounded cell-holiday"></div><span class="text-xs font-bold">H</span></div>
              <span class="text-xs text-gray-400">= Holiday/Sunday</span>
            </div>
            <div class="w-px h-6 bg-slate-700"></div>
            <div class="flex items-center gap-2 text-xs">
              <span class="text-emerald-400">â†‘ Up</span>
              <span class="text-gray-400">â†’ Stable</span>
              <span class="text-red-400">â†“ Down</span>
            </div>
            <div class="w-px h-6 bg-slate-700"></div>
            <div class="flex items-center gap-2 text-xs">
              <span class="px-2 py-0.5 bg-blue-600 rounded">ğŸ†• New Joiner</span>
              <span class="px-2 py-0.5 bg-orange-600 rounded">ğŸšª Resigned</span>
            </div>
          </div>
        </div>

        <!-- Main Table -->
        <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
          <div class="overflow-x-auto">
            <table id="main-table" class="w-full text-sm">
              <thead id="table-header" class="bg-slate-800 sticky top-0"></thead>
              <tbody id="table-body"></tbody>
            </table>
          </div>
        </div>

        <!-- Footer Stats -->
        <div id="footer-stats" class="grid md:grid-cols-3 gap-4"></div>

        <!-- Footer -->
        <div class="text-center text-gray-500 text-sm py-4 no-print">
          Performance Tracker Pro v2.0 â€¢ Corporate Analytics Dashboard
        </div>
      </main>
    </div>

    <!-- Holiday Manager Modal -->
    <div id="holiday-modal" class="fixed inset-0 z-50 hidden">
      <div class="modal-overlay absolute inset-0" onclick="closeModal('holiday-modal')"></div>
      <div class="relative z-10 flex items-center justify-center min-h-screen p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden animate-slide-in">
          <div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
            <div>
              <h2 class="text-xl font-bold">ğŸ“… Holiday Manager</h2>
              <p class="text-sm text-gray-400">Sundays auto-excluded â€¢ Manage company holidays</p>
            </div>
            <button onclick="closeModal('holiday-modal')" class="p-2 hover:bg-slate-800 rounded-lg text-gray-400 hover:text-white">âœ•</button>
          </div>
          
          <!-- Year Selector -->
          <div class="px-6 py-3 bg-slate-800/50 border-b border-slate-700">
            <div class="flex items-center gap-4">
              <label class="text-sm text-gray-400">Year:</label>
              <select id="holiday-year-select" class="bg-slate-800 border border-slate-600 text-gray-100 px-3 py-1 rounded-lg text-sm">
                <option value="2025">2025</option>
                <option value="2026" selected>2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
              </select>
              <button id="clear-all-holidays-btn" class="px-3 py-1 bg-red-600/20 text-red-400 hover:bg-red-600/30 rounded-lg text-xs">Clear All</button>
            </div>
          </div>
          
          <!-- Add Holiday Form -->
          <div class="px-6 py-4 border-b border-slate-700 bg-slate-800/30">
            <div class="flex flex-col sm:flex-row gap-3">
              <div class="flex-1">
                <label class="block text-xs text-gray-400 mb-1">Date</label>
                <input type="date" id="holiday-date" class="w-full bg-slate-800 border border-slate-600 text-gray-100 px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500">
              </div>
              <div class="flex-1">
                <label class="block text-xs text-gray-400 mb-1">Holiday Name</label>
                <input type="text" id="holiday-name" placeholder="e.g., Republic Day" class="w-full bg-slate-800 border border-slate-600 text-gray-100 px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500">
              </div>
              <div class="flex items-end">
                <button id="add-holiday-btn" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg text-sm font-medium transition-all">â• Add</button>
              </div>
            </div>
          </div>
          
          <!-- Bulk Import -->
          <div class="px-6 py-3 border-b border-slate-700 bg-slate-800/20">
            <details class="text-sm">
              <summary class="cursor-pointer text-cyan-400 hover:text-cyan-300">ğŸ“¥ Bulk Import Holidays</summary>
              <div class="mt-3">
                <textarea id="bulk-holiday-input" placeholder="Paste holidays (one per line):&#10;2026-01-26, Republic Day&#10;2026-03-03, Holi" class="w-full h-24 bg-slate-800 border border-slate-600 text-gray-100 px-3 py-2 rounded-lg text-xs font-mono"></textarea>
                <button id="bulk-import-btn" class="mt-2 px-3 py-1 bg-cyan-600 hover:bg-cyan-500 rounded text-xs">Import</button>
              </div>
            </details>
          </div>
          
          <!-- Holiday List -->
          <div class="px-6 py-4 overflow-y-auto max-h-[35vh]">
            <div id="holiday-list" class="space-y-2"></div>
          </div>
          
          <div class="px-6 py-4 border-t border-slate-700 bg-slate-800/50 flex justify-between items-center">
            <div class="text-sm text-gray-400"><span id="holiday-count">0</span> holidays</div>
            <button onclick="closeModal('holiday-modal')" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-medium">âœ… Done</button>
          </div>
        </div>
      </div>
    </div>

    <!-- New Joiner Modal -->
    <div id="joiner-modal" class="fixed inset-0 z-50 hidden">
      <div class="modal-overlay absolute inset-0" onclick="closeModal('joiner-modal')"></div>
      <div class="relative z-10 flex items-center justify-center min-h-screen p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden animate-slide-in">
          <div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
            <div>
              <h2 class="text-xl font-bold">ğŸ†• New Joiner Register</h2>
              <p class="text-sm text-gray-400">Add employees who joined mid-month â€¢ Target auto-adjusted</p>
            </div>
            <button onclick="closeModal('joiner-modal')" class="p-2 hover:bg-slate-800 rounded-lg text-gray-400 hover:text-white">âœ•</button>
          </div>
          
          <!-- Add Joiner Form -->
          <div class="px-6 py-4 border-b border-slate-700 bg-slate-800/30">
            <div class="flex flex-col sm:flex-row gap-3">
              <div class="flex-1">
                <label class="block text-xs text-gray-400 mb-1">Employee Name</label>
                <input type="text" id="joiner-name" placeholder="e.g., Swati Adhikari" class="w-full bg-slate-800 border border-slate-600 text-gray-100 px-3 py-2 rounded-lg text-sm">
              </div>
              <div class="w-32">
                <label class="block text-xs text-gray-400 mb-1">ID (PR###)</label>
                <input type="text" id="joiner-id" placeholder="PR104" class="w-full bg-slate-800 border border-slate-600 text-gray-100 px-3 py-2 rounded-lg text-sm">
              </div>
              <div class="w-40">
                <label class="block text-xs text-gray-400 mb-1">Joining Date</label>
                <input type="date" id="joiner-date" class="w-full bg-slate-800 border border-slate-600 text-gray-100 px-3 py-2 rounded-lg text-sm">
              </div>
              <div class="flex items-end">
                <button id="add-joiner-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-medium">â• Add</button>
              </div>
            </div>
          </div>
          
          <!-- Joiner List -->
          <div class="px-6 py-4 overflow-y-auto max-h-[40vh]">
            <div id="joiner-list" class="space-y-2"></div>
            <p id="joiner-empty" class="text-gray-500 text-sm text-center py-8">No new joiners added</p>
          </div>
          
          <div class="px-6 py-4 border-t border-slate-700 bg-slate-800/50 flex justify-between items-center">
            <div class="text-sm text-gray-400"><span id="joiner-count">0</span> new joiners</div>
            <button onclick="closeModal('joiner-modal')" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-medium">âœ… Done</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Resigned Modal -->
    <div id="resigned-modal" class="fixed inset-0 z-50 hidden">
      <div class="modal-overlay absolute inset-0" onclick="closeModal('resigned-modal')"></div>
      <div class="relative z-10 flex items-center justify-center min-h-screen p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden animate-slide-in">
          <div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
            <div>
              <h2 class="text-xl font-bold">ğŸšª Resigned Employee Register</h2>
              <p class="text-sm text-gray-400">Add employees who resigned â€¢ Target calculated till last day</p>
            </div>
            <button onclick="closeModal('resigned-modal')" class="p-2 hover:bg-slate-800 rounded-lg text-gray-400 hover:text-white">âœ•</button>
          </div>
          
          <!-- Add Resigned Form -->
          <div class="px-6 py-4 border-b border-slate-700 bg-slate-800/30">
            <div class="flex flex-col sm:flex-row gap-3">
              <div class="flex-1">
                <label class="block text-xs text-gray-400 mb-1">Employee Name</label>
                <input type="text" id="resigned-name" placeholder="e.g., Neha Das" class="w-full bg-slate-800 border border-slate-600 text-gray-100 px-3 py-2 rounded-lg text-sm">
              </div>
              <div class="w-32">
                <label class="block text-xs text-gray-400 mb-1">ID (PR###)</label>
                <input type="text" id="resigned-id" placeholder="PR045" class="w-full bg-slate-800 border border-slate-600 text-gray-100 px-3 py-2 rounded-lg text-sm">
              </div>
              <div class="w-40">
                <label class="block text-xs text-gray-400 mb-1">Last Working Date</label>
                <input type="date" id="resigned-date" class="w-full bg-slate-800 border border-slate-600 text-gray-100 px-3 py-2 rounded-lg text-sm">
              </div>
              <div class="flex items-end">
                <button id="add-resigned-btn" class="px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded-lg text-sm font-medium">â• Add</button>
              </div>
            </div>
          </div>
          
          <!-- Resigned List -->
          <div class="px-6 py-4 overflow-y-auto max-h-[40vh]">
            <div id="resigned-list" class="space-y-2"></div>
            <p id="resigned-empty" class="text-gray-500 text-sm text-center py-8">No resigned employees added</p>
          </div>
          
          <div class="px-6 py-4 border-t border-slate-700 bg-slate-800/50 flex justify-between items-center">
            <div class="text-sm text-gray-400"><span id="resigned-count">0</span> resigned</div>
            <button onclick="closeModal('resigned-modal')" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-medium">âœ… Done</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Modal (Import/Export) -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
      <div class="modal-overlay absolute inset-0" onclick="closeModal('settings-modal')"></div>
      <div class="relative z-10 flex items-center justify-center min-h-screen p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-md overflow-hidden animate-slide-in">
          <div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
            <div>
              <h2 class="text-xl font-bold">âš™ï¸ Settings</h2>
              <p class="text-sm text-gray-400">Import/Export configuration</p>
            </div>
            <button onclick="closeModal('settings-modal')" class="p-2 hover:bg-slate-800 rounded-lg text-gray-400 hover:text-white">âœ•</button>
          </div>
          
          <div class="p-6 space-y-4">
            <!-- Export -->
            <div class="bg-slate-800 rounded-xl p-4">
              <h3 class="font-semibold text-emerald-400 mb-2">ğŸ“¤ Export Settings</h3>
              <p class="text-xs text-gray-400 mb-3">Download all settings (Holidays, New Joiners, Resigned) as JSON file. Share with your team.</p>
              <button id="export-settings-btn" class="w-full px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-sm font-medium">Download Settings File</button>
            </div>
            
            <!-- Import -->
            <div class="bg-slate-800 rounded-xl p-4">
              <h3 class="font-semibold text-cyan-400 mb-2">ğŸ“¥ Import Settings</h3>
              <p class="text-xs text-gray-400 mb-3">Load settings from a shared JSON file. This will replace current settings.</p>
              <input type="file" id="import-settings-input" accept=".json" class="hidden">
              <button id="import-settings-btn" class="w-full px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg text-sm font-medium">Select Settings File</button>
            </div>
            
            <!-- Current Data Summary -->
            <div class="bg-slate-800/50 rounded-xl p-4 text-sm">
              <h3 class="font-semibold text-gray-300 mb-2">ğŸ“Š Current Data</h3>
              <div class="space-y-1 text-gray-400">
                <div class="flex justify-between"><span>Holidays:</span><span id="settings-holiday-count" class="text-white">0</span></div>
                <div class="flex justify-between"><span>New Joiners:</span><span id="settings-joiner-count" class="text-white">0</span></div>
                <div class="flex justify-between"><span>Resigned:</span><span id="settings-resigned-count" class="text-white">0</span></div>
              </div>
            </div>
          </div>
          
          <div class="px-6 py-4 border-t border-slate-700 bg-slate-800/50">
            <button onclick="closeModal('settings-modal')" class="w-full px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-medium">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== GLOBAL STATE ====================
    let appData = null;
    let reportMode = 'mtd'; // 'mtd' or 'ytd'
    let darkMode = true;
    let searchTerm = '';
    let filterStatus = 'all';
    let sortBy = 'name-asc';
    let dateFilter = { from: null, to: null };
    let ytdFiles = [];
    
    // ==================== DATA STORAGE ====================
    const DEFAULT_HOLIDAYS_2026 = [
      { date: '2026-01-26', name: 'Republic Day' },
      { date: '2026-03-03', name: 'Dol Jatra / Holi' },
      { date: '2026-05-01', name: 'May Day' },
      { date: '2026-06-26', name: 'Muharram' },
      { date: '2026-07-16', name: 'Rathayatra' },
      { date: '2026-10-19', name: 'Durga Puja' },
      { date: '2026-10-20', name: 'Durga Puja' },
      { date: '2026-10-21', name: 'Durga Puja' },
      { date: '2026-11-09', name: 'Kali Puja / Diwali' },
      { date: '2026-12-25', name: 'Christmas Day' }
    ];
    
    let holidays = [];
    let newJoiners = [];
    let resignedEmployees = [];

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', () => {
      loadAllData();
      setupEventListeners();
    });

    function loadAllData() {
      // Load holidays
      const storedHolidays = localStorage.getItem('pt_holidays');
      holidays = storedHolidays ? JSON.parse(storedHolidays) : [...DEFAULT_HOLIDAYS_2026];
      
      // Load new joiners
      const storedJoiners = localStorage.getItem('pt_joiners');
      newJoiners = storedJoiners ? JSON.parse(storedJoiners) : [];
      
      // Load resigned
      const storedResigned = localStorage.getItem('pt_resigned');
      resignedEmployees = storedResigned ? JSON.parse(storedResigned) : [];
      
      saveAllData();
    }

    function saveAllData() {
      localStorage.setItem('pt_holidays', JSON.stringify(holidays));
      localStorage.setItem('pt_joiners', JSON.stringify(newJoiners));
      localStorage.setItem('pt_resigned', JSON.stringify(resignedEmployees));
    }

    // ==================== EVENT LISTENERS ====================
    function setupEventListeners() {
      // Mode selection
      document.getElementById('mtd-mode-btn').addEventListener('click', () => setReportMode('mtd'));
      document.getElementById('ytd-mode-btn').addEventListener('click', () => setReportMode('ytd'));
      
      // File uploads
      const mtdZone = document.getElementById('mtd-upload-zone');
      const fileInput = document.getElementById('file-input');
      mtdZone.addEventListener('click', () => fileInput.click());
      mtdZone.addEventListener('dragover', handleDragOver);
      mtdZone.addEventListener('dragleave', handleDragLeave);
      mtdZone.addEventListener('drop', handleMTDDrop);
      fileInput.addEventListener('change', handleMTDFileSelect);
      
      const ytdZone = document.getElementById('ytd-upload-zone');
      const ytdInput = document.getElementById('ytd-file-input');
      ytdZone.addEventListener('click', (e) => { if(e.target === ytdZone || e.target.closest('div:not(#ytd-files-list)')) ytdInput.click(); });
      ytdZone.addEventListener('dragover', handleDragOver);
      ytdZone.addEventListener('dragleave', handleDragLeave);
      ytdZone.addEventListener('drop', handleYTDDrop);
      ytdInput.addEventListener('change', handleYTDFileSelect);
      document.getElementById('process-ytd-btn').addEventListener('click', processYTDFiles);
      
      // Dashboard controls
      document.getElementById('search-input').addEventListener('input', (e) => { searchTerm = e.target.value; renderTable(); });
      document.getElementById('filter-select').addEventListener('change', (e) => { filterStatus = e.target.value; renderTable(); });
      document.getElementById('sort-select').addEventListener('change', (e) => { sortBy = e.target.value; renderTable(); });
      document.getElementById('apply-date-filter').addEventListener('click', applyDateFilter);
      document.getElementById('clear-date-filter').addEventListener('click', clearDateFilter);
      
      // Header buttons
      document.getElementById('download-pdf-btn').addEventListener('click', downloadPDF);
      document.getElementById('download-excel-btn').addEventListener('click', downloadExcel);
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
      document.getElementById('fullscreen-toggle').addEventListener('click', toggleFullscreen);
      document.getElementById('print-btn').addEventListener('click', () => window.print());
      document.getElementById('new-upload-btn').addEventListener('click', resetApp);
      
      // Modal openers
      document.getElementById('manage-holidays-btn-upload').addEventListener('click', () => openModal('holiday-modal'));
      document.getElementById('manage-holidays-btn').addEventListener('click', () => openModal('holiday-modal'));
      document.getElementById('manage-joiners-btn-upload').addEventListener('click', () => openModal('joiner-modal'));
      document.getElementById('manage-joiners-btn').addEventListener('click', () => openModal('joiner-modal'));
      document.getElementById('manage-resigned-btn-upload').addEventListener('click', () => openModal('resigned-modal'));
      document.getElementById('manage-resigned-btn').addEventListener('click', () => openModal('resigned-modal'));
      document.getElementById('settings-btn-upload').addEventListener('click', () => openModal('settings-modal'));
      document.getElementById('settings-btn').addEventListener('click', () => openModal('settings-modal'));
      
      // Holiday modal
      document.getElementById('holiday-year-select').addEventListener('change', renderHolidayList);
      document.getElementById('add-holiday-btn').addEventListener('click', addHoliday);
      document.getElementById('clear-all-holidays-btn').addEventListener('click', clearAllHolidays);
      document.getElementById('bulk-import-btn').addEventListener('click', bulkImportHolidays);
      document.getElementById('holiday-name').addEventListener('keypress', (e) => { if(e.key === 'Enter') addHoliday(); });
      
      // Joiner modal
      document.getElementById('add-joiner-btn').addEventListener('click', addJoiner);
      document.getElementById('joiner-id').addEventListener('keypress', (e) => { if(e.key === 'Enter') addJoiner(); });
      
      // Resigned modal
      document.getElementById('add-resigned-btn').addEventListener('click', addResigned);
      document.getElementById('resigned-id').addEventListener('keypress', (e) => { if(e.key === 'Enter') addResigned(); });
      
      // Settings modal
      document.getElementById('export-settings-btn').addEventListener('click', exportSettings);
      document.getElementById('import-settings-btn').addEventListener('click', () => document.getElementById('import-settings-input').click());
      document.getElementById('import-settings-input').addEventListener('change', importSettings);
    }

    // ==================== REPORT MODE ====================
    function setReportMode(mode) {
      reportMode = mode;
      document.getElementById('mtd-mode-btn').className = mode === 'mtd' 
        ? 'px-6 py-3 bg-cyan-600 hover:bg-cyan-500 rounded-xl text-sm font-medium transition-all'
        : 'px-6 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl text-sm font-medium transition-all';
      document.getElementById('ytd-mode-btn').className = mode === 'ytd'
        ? 'px-6 py-3 bg-purple-600 hover:bg-purple-500 rounded-xl text-sm font-medium transition-all'
        : 'px-6 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl text-sm font-medium transition-all';
      document.getElementById('mtd-upload-zone').classList.toggle('hidden', mode !== 'mtd');
      document.getElementById('ytd-upload-zone').classList.toggle('hidden', mode !== 'ytd');
    }

    // ==================== FILE HANDLING ====================
    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('border-cyan-500', 'bg-cyan-500/10');
    }

    function handleDragLeave(e) {
      e.currentTarget.classList.remove('border-cyan-500', 'bg-cyan-500/10');
    }

    function handleMTDDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('border-cyan-500', 'bg-cyan-500/10');
      const file = e.dataTransfer.files[0];
      if (file && (file.name.endsWith('.xls') || file.name.endsWith('.xlsx'))) {
        parseExcelFile(file);
      } else {
        alert('Please upload a valid Excel file (.xls or .xlsx)');
      }
    }

    function handleMTDFileSelect(e) {
      const file = e.target.files[0];
      if (file) parseExcelFile(file);
    }

    function handleYTDDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('border-cyan-500', 'bg-cyan-500/10');
      const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.xls') || f.name.endsWith('.xlsx'));
      if (files.length > 0) {
        ytdFiles = files;
        showYTDFilesList();
      }
    }

    function handleYTDFileSelect(e) {
      ytdFiles = Array.from(e.target.files);
      showYTDFilesList();
    }

    function showYTDFilesList() {
      const container = document.getElementById('ytd-files-list');
      container.innerHTML = ytdFiles.map((f, i) => `
        <div class="flex justify-between items-center py-1 text-sm">
          <span>${i + 1}. ${f.name}</span>
          <span class="text-gray-500">${(f.size / 1024).toFixed(1)} KB</span>
        </div>
      `).join('');
      container.classList.remove('hidden');
      document.getElementById('process-ytd-btn').classList.remove('hidden');
    }

    async function processYTDFiles() {
      if (ytdFiles.length === 0) return;
      
      const allMonthsData = [];
      for (const file of ytdFiles) {
        const data = await readExcelFile(file);
        allMonthsData.push(data);
      }
      
      processYTDData(allMonthsData);
    }

    function readExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const workbook = XLSX.read(e.target.result, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            resolve(jsonData);
          } catch (error) {
            reject(error);
          }
        };
        reader.readAsArrayBuffer(file);
      });
    }

    function parseExcelFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const workbook = XLSX.read(e.target.result, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          processData(jsonData);
        } catch (error) {
          alert('Error parsing Excel file. Please check the format.');
          console.error(error);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // ==================== DATE & HOLIDAY FUNCTIONS ====================
    function isHoliday(year, month, day) {
      const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      return holidays.some(h => h.date === dateStr);
    }

    function isSunday(year, month, day) {
      return new Date(year, month - 1, day).getDay() === 0;
    }

    function isNonWorkingDay(year, month, day) {
      return isSunday(year, month, day) || isHoliday(year, month, day);
    }

    function getWorkingDaysInRange(year, month, fromDay, toDay) {
      let count = 0;
      for (let d = fromDay; d <= toDay; d++) {
        if (!isNonWorkingDay(year, month, d)) count++;
      }
      return count;
    }

    function getNonWorkingDaysInfo(year, month, fromDay, toDay) {
      let sundays = 0, holidayCount = 0;
      for (let d = fromDay; d <= toDay; d++) {
        if (isSunday(year, month, d)) sundays++;
        else if (isHoliday(year, month, d)) holidayCount++;
      }
      return { sundays, holidays: holidayCount, total: sundays + holidayCount };
    }

    // ==================== NEW JOINER / RESIGNED HELPERS ====================
    function getJoinerInfo(employeeId) {
      return newJoiners.find(j => j.id.toUpperCase() === employeeId.toUpperCase());
    }

    function getResignedInfo(employeeId) {
      return resignedEmployees.find(r => r.id.toUpperCase() === employeeId.toUpperCase());
    }

    function getEffectiveDateRange(employeeId, year, month, defaultFromDay, defaultToDay) {
      let fromDay = defaultFromDay;
      let toDay = defaultToDay;
      
      const joiner = getJoinerInfo(employeeId);
      if (joiner) {
        const jDate = new Date(joiner.date);
        if (jDate.getFullYear() === year && jDate.getMonth() + 1 === month) {
          fromDay = Math.max(fromDay, jDate.getDate());
        }
      }
      
      const resigned = getResignedInfo(employeeId);
      if (resigned) {
        const rDate = new Date(resigned.date);
        if (rDate.getFullYear() === year && rDate.getMonth() + 1 === month) {
          toDay = Math.min(toDay, rDate.getDate());
        }
      }
      
      return { fromDay, toDay };
    }

    // ==================== DATA PROCESSING ====================
    function processData(jsonData) {
      const reportDateStr = jsonData[0]?.[0] || '';
      const dateMatch = reportDateStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
      const currentDay = dateMatch ? parseInt(dateMatch[1]) : 13;
      const currentMonth = dateMatch ? parseInt(dateMatch[2]) : 1;
      const currentYear = dateMatch ? parseInt(dateMatch[3]) : 2026;

      // Set date filter defaults
      const monthStart = `${currentYear}-${String(currentMonth).padStart(2, '0')}-01`;
      const monthEnd = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
      document.getElementById('date-from').value = monthStart;
      document.getElementById('date-from').min = monthStart;
      document.getElementById('date-from').max = monthEnd;
      document.getElementById('date-to').value = monthEnd;
      document.getElementById('date-to').min = monthStart;
      document.getElementById('date-to').max = monthEnd;

      // Calculate date range
      const filterFromDay = dateFilter.from ? new Date(dateFilter.from).getDate() : 1;
      const filterToDay = dateFilter.to ? new Date(dateFilter.to).getDate() : currentDay;

      const employees = [];
      for (let i = 4; i < jsonData.length - 2; i++) {
        const row = jsonData[i];
        if (!row || !row[1]) continue;

        const decoName = row[1]?.toString() || '';
        const prMatch = decoName.match(/\(PR\d+\)/);
        if (!prMatch) continue;

        const employeeId = prMatch[0].replace(/[()]/g, '');
        const dailyTarget = parseInt(row[6]) || 8;
        const retailPending = parseInt(row[2]) || 0;
        const prolinksPending = parseInt(row[4]) || 0;
        const svgPending = parseInt(row[5]) || 0;

        // Get effective date range for this employee
        const effectiveRange = getEffectiveDateRange(employeeId, currentYear, currentMonth, filterFromDay, filterToDay);
        const empFromDay = effectiveRange.fromDay;
        const empToDay = effectiveRange.toDay;

        // Check joiner/resigned status
        const joinerInfo = getJoinerInfo(employeeId);
        const resignedInfo = getResignedInfo(employeeId);

        const dailyData = [];
        let totalDone = 0, totalRetail = 0, totalProlinks = 0, totalSvg = 0;

        for (let day = 1; day <= 31; day++) {
          const baseCol = 7 + (day - 1) * 3;
          const retail = parseInt(row[baseCol]) || 0;
          const prolinks = parseInt(row[baseCol + 1]) || 0;
          const svg = parseInt(row[baseCol + 2]) || 0;
          const total = retail + prolinks + svg;
          const isNonWorking = isNonWorkingDay(currentYear, currentMonth, day);
          const isInRange = day >= empFromDay && day <= empToDay && day <= currentDay;

          dailyData.push({ 
            day, retail, prolinks, svg, total,
            isActive: day <= currentDay,
            isInRange,
            isNonWorking,
            isSunday: isSunday(currentYear, currentMonth, day),
            isHoliday: isHoliday(currentYear, currentMonth, day)
          });

          if (isInRange && !isNonWorking) {
            totalDone += total;
            totalRetail += retail;
            totalProlinks += prolinks;
            totalSvg += svg;
          }
        }

        const workingDays = getWorkingDaysInRange(currentYear, currentMonth, empFromDay, empToDay);
        const targetRequired = dailyTarget * workingDays;
        const shortfall = Math.max(0, targetRequired - totalDone);
        const achievementPct = targetRequired > 0 ? (totalDone / targetRequired * 100) : 0;

        const workingDaysData = dailyData.filter(d => d.isInRange && !d.isNonWorking);
        const trend = calculateTrend(workingDaysData.slice(-5));
        const alerts = calculateAlerts(workingDaysData, dailyTarget, achievementPct);

        employees.push({
          name: decoName.replace(/\s*\(PR\d+\)/, '').trim(),
          id: employeeId,
          fullName: decoName,
          dailyTarget,
          dailyData,
          totalDone,
          totalRetail,
          totalProlinks,
          totalSvg,
          targetRequired,
          shortfall,
          achievementPct,
          workingDays,
          retailPending,
          prolinksPending,
          svgPending,
          totalPending: retailPending + prolinksPending + svgPending,
          trend,
          alerts,
          isNewJoiner: !!joinerInfo,
          joinerDate: joinerInfo?.date,
          isResigned: !!resignedInfo,
          resignedDate: resignedInfo?.date,
          effectiveFromDay: empFromDay,
          effectiveToDay: empToDay
        });
      }

      const sortedByAchievement = [...employees].sort((a, b) => b.achievementPct - a.achievementPct);
      const globalWorkingDays = getWorkingDaysInRange(currentYear, currentMonth, filterFromDay, filterToDay);
      const nonWorkingInfo = getNonWorkingDaysInfo(currentYear, currentMonth, filterFromDay, filterToDay);

      appData = {
        employees,
        currentDay,
        currentMonth,
        currentYear,
        filterFromDay,
        filterToDay,
        reportDate: `${currentDay}/${String(currentMonth).padStart(2, '0')}/${currentYear}`,
        dateRangeText: filterFromDay === 1 && filterToDay === currentDay 
          ? `1 - ${currentDay} ${getMonthName(currentMonth)}`
          : `${filterFromDay} - ${filterToDay} ${getMonthName(currentMonth)}`,
        workingDays: globalWorkingDays,
        nonWorkingInfo,
        leaderboard: sortedByAchievement.slice(0, 5),
        champion: sortedByAchievement[0],
        teamStats: calculateTeamStats(employees, globalWorkingDays, nonWorkingInfo)
      };

      showDashboard();
    }

    function processYTDData(allMonthsData) {
      // Combine data from multiple months
      const employeeMap = new Map();
      
      allMonthsData.forEach(jsonData => {
        const reportDateStr = jsonData[0]?.[0] || '';
        const dateMatch = reportDateStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
        const currentDay = dateMatch ? parseInt(dateMatch[1]) : 31;
        const currentMonth = dateMatch ? parseInt(dateMatch[2]) : 1;
        const currentYear = dateMatch ? parseInt(dateMatch[3]) : 2026;

        for (let i = 4; i < jsonData.length - 2; i++) {
          const row = jsonData[i];
          if (!row || !row[1]) continue;

          const decoName = row[1]?.toString() || '';
          const prMatch = decoName.match(/\(PR\d+\)/);
          if (!prMatch) continue;

          const employeeId = prMatch[0].replace(/[()]/g, '');
          const dailyTarget = parseInt(row[6]) || 8;

          // Calculate monthly totals
          let monthTotal = 0;
          const workingDays = getWorkingDaysInRange(currentYear, currentMonth, 1, currentDay);
          
          for (let day = 1; day <= currentDay; day++) {
            if (!isNonWorkingDay(currentYear, currentMonth, day)) {
              const baseCol = 7 + (day - 1) * 3;
              const retail = parseInt(row[baseCol]) || 0;
              const prolinks = parseInt(row[baseCol + 1]) || 0;
              const svg = parseInt(row[baseCol + 2]) || 0;
              monthTotal += retail + prolinks + svg;
            }
          }

          const monthTarget = dailyTarget * workingDays;

          if (!employeeMap.has(employeeId)) {
            employeeMap.set(employeeId, {
              name: decoName.replace(/\s*\(PR\d+\)/, '').trim(),
              id: employeeId,
              fullName: decoName,
              dailyTarget,
              totalDone: 0,
              targetRequired: 0,
              workingDays: 0,
              months: []
            });
          }

          const emp = employeeMap.get(employeeId);
          emp.totalDone += monthTotal;
          emp.targetRequired += monthTarget;
          emp.workingDays += workingDays;
          emp.months.push({ month: currentMonth, year: currentYear, output: monthTotal, target: monthTarget });
        }
      });

      // Convert to array and calculate final metrics
      const employees = Array.from(employeeMap.values()).map(emp => ({
        ...emp,
        shortfall: Math.max(0, emp.targetRequired - emp.totalDone),
        achievementPct: emp.targetRequired > 0 ? (emp.totalDone / emp.targetRequired * 100) : 0,
        trend: 'stable',
        alerts: [],
        isNewJoiner: !!getJoinerInfo(emp.id),
        isResigned: !!getResignedInfo(emp.id)
      }));

      const sortedByAchievement = [...employees].sort((a, b) => b.achievementPct - a.achievementPct);
      const totalWorkingDays = employees.reduce((sum, e) => sum + e.workingDays, 0) / employees.length;

      appData = {
        employees,
        currentDay: 0,
        currentMonth: 0,
        currentYear: 2026,
        filterFromDay: 1,
        filterToDay: 31,
        reportDate: 'YTD Report',
        dateRangeText: `${ytdFiles.length} Months Combined`,
        workingDays: Math.round(totalWorkingDays),
        nonWorkingInfo: { sundays: 0, holidays: 0, total: 0 },
        leaderboard: sortedByAchievement.slice(0, 5),
        champion: sortedByAchievement[0],
        teamStats: calculateTeamStats(employees, Math.round(totalWorkingDays), { sundays: 0, holidays: 0, total: 0 }),
        isYTD: true
      };

      document.getElementById('report-type-badge').textContent = 'YTD';
      document.getElementById('report-type-badge').className = 'px-3 py-1 rounded-full text-xs font-medium bg-purple-900/50 text-purple-400';
      showDashboard();
    }

    // ==================== CALCULATION HELPERS ====================
    function calculateTrend(lastDays) {
      if (lastDays.length < 3) return 'stable';
      const recent = lastDays.slice(-2).reduce((a, b) => a + b.total, 0) / 2;
      const earlier = lastDays.slice(0, 2).reduce((a, b) => a + b.total, 0) / 2;
      if (recent - earlier > 1) return 'up';
      if (earlier - recent > 1) return 'down';
      return 'stable';
    }

    function calculateAlerts(workingDaysData, target, achievementPct) {
      const alerts = [];
      const last3 = workingDaysData.slice(-3);
      const threshold = target === 10 ? 8 : 6;

      if (last3.length === 3 && last3.every(d => d.total < threshold)) {
        alerts.push({ type: 'critical', icon: 'ğŸ”´', message: '3+ days below target' });
      }
      if (achievementPct < 80 && workingDaysData.length > 5) {
        alerts.push({ type: 'warning', icon: 'âš ï¸', message: 'At risk' });
      }
      const lastDay = workingDaysData[workingDaysData.length - 1];
      if (lastDay && lastDay.total === 0) {
        alerts.push({ type: 'inactive', icon: 'ğŸ‘»', message: 'No output today' });
      }
      if (achievementPct >= 110) {
        alerts.push({ type: 'star', icon: 'â­', message: 'Star performer' });
      }
      return alerts;
    }

    function calculateTeamStats(employees, workingDays, nonWorkingInfo) {
      const total = employees.length;
      if (total === 0) return {};
      
      const avgAchievement = employees.reduce((a, b) => a + b.achievementPct, 0) / total;
      const onTrack = employees.filter(e => e.achievementPct >= 100).length;
      const atRisk = employees.filter(e => e.achievementPct >= 80 && e.achievementPct < 100).length;
      const critical = employees.filter(e => e.achievementPct < 80).length;
      const totalOutput = employees.reduce((a, b) => a + b.totalDone, 0);
      const totalTarget = employees.reduce((a, b) => a + b.targetRequired, 0);
      const newJoinersCount = employees.filter(e => e.isNewJoiner).length;
      const resignedCount = employees.filter(e => e.isResigned).length;

      return { 
        total, avgAchievement, onTrack, atRisk, critical, 
        totalOutput, totalTarget, workingDays, nonWorkingInfo,
        newJoinersCount, resignedCount
      };
    }

    function getMonthName(month) {
      const months = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return months[month] || '';
    }

    // ==================== DATE FILTER ====================
    function applyDateFilter() {
      const fromDate = document.getElementById('date-from').value;
      const toDate = document.getElementById('date-to').value;
      if (fromDate && toDate) {
        dateFilter = { from: fromDate, to: toDate };
        // Reprocess with new date filter - need to reload from original data
        // For simplicity, show a message
        alert('Date filter applied. Please re-upload the Excel file to apply the new date range.');
      }
    }

    function clearDateFilter() {
      dateFilter = { from: null, to: null };
      document.getElementById('date-from').value = '';
      document.getElementById('date-to').value = '';
    }

    // ==================== DASHBOARD RENDERING ====================
    function showDashboard() {
      document.getElementById('upload-screen').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      renderDashboard();
    }

    function renderDashboard() {
      document.getElementById('report-date-badge').textContent = `ğŸ“… ${appData.dateRangeText}`;
      document.getElementById('working-days-badge').textContent = `âœ… ${appData.workingDays} Working Days`;
      renderSummaryCards();
      renderChampion();
      renderLeaderboard();
      renderTable();
      renderFooterStats();
    }

    function renderSummaryCards() {
      const stats = appData.teamStats;
      document.getElementById('summary-cards').innerHTML = `
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-3">
          <div class="text-xs uppercase tracking-wide text-gray-500 mb-1">Employees</div>
          <div class="text-xl font-bold">${stats.total}</div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-3">
          <div class="text-xs uppercase tracking-wide text-emerald-400 mb-1">Working Days</div>
          <div class="text-xl font-bold text-emerald-400">${stats.workingDays}</div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-3">
          <div class="text-xs uppercase tracking-wide text-gray-500 mb-1">Team Output</div>
          <div class="text-xl font-bold text-cyan-400">${stats.totalOutput?.toLocaleString() || 0}</div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-3">
          <div class="text-xs uppercase tracking-wide text-gray-500 mb-1">Avg %</div>
          <div class="text-xl font-bold">${stats.avgAchievement?.toFixed(1) || 0}%</div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-3">
          <div class="text-xs uppercase tracking-wide text-emerald-400 mb-1">âœ… On Track</div>
          <div class="text-xl font-bold text-emerald-400">${stats.onTrack}</div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-3">
          <div class="text-xs uppercase tracking-wide text-red-400 mb-1">ğŸ”´ Critical</div>
          <div class="text-xl font-bold text-red-400">${stats.critical}</div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-3">
          <div class="text-xs uppercase tracking-wide text-blue-400 mb-1">ğŸ†• Joiners</div>
          <div class="text-xl font-bold text-blue-400">${stats.newJoinersCount}</div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-3">
          <div class="text-xs uppercase tracking-wide text-orange-400 mb-1">ğŸšª Resigned</div>
          <div class="text-xl font-bold text-orange-400">${stats.resignedCount}</div>
        </div>
      `;
    }

    function renderChampion() {
      const champ = appData.champion;
      document.getElementById('champion-card').innerHTML = `
        <div class="flex items-center gap-2 mb-4">
          <span class="text-3xl">ğŸ†</span>
          <div>
            <div class="text-xs uppercase tracking-wide text-gray-400">Champion</div>
            <div class="text-lg font-bold">${champ?.name || 'TBD'}</div>
          </div>
        </div>
        ${champ ? `
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div><div class="text-gray-400">Output</div><div class="font-bold text-lg">${champ.totalDone}</div></div>
            <div><div class="text-gray-400">Achievement</div><div class="font-bold text-lg text-emerald-400">${champ.achievementPct.toFixed(1)}%</div></div>
          </div>
        ` : ''}
      `;
    }

    function renderLeaderboard() {
      const top5 = appData.leaderboard;
      const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'];
      document.getElementById('leaderboard-card').innerHTML = `
        <div class="flex items-center gap-2 mb-4"><span class="text-xl">ğŸ–ï¸</span><div class="font-semibold">Top 5 Performers</div></div>
        <div class="grid grid-cols-1 sm:grid-cols-5 gap-2">
          ${top5.map((emp, i) => `
            <div class="flex items-center gap-2 p-2 rounded-lg bg-slate-800">
              <span class="text-lg">${medals[i]}</span>
              <div class="min-w-0">
                <div class="font-medium text-sm truncate">${emp.name}</div>
                <div class="text-xs text-gray-400">${emp.achievementPct.toFixed(0)}%</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function getFilteredAndSortedEmployees() {
      let filtered = appData.employees;

      if (searchTerm) {
        filtered = filtered.filter(e => e.fullName.toLowerCase().includes(searchTerm.toLowerCase()));
      }

      switch (filterStatus) {
        case 'ontrack': filtered = filtered.filter(e => e.achievementPct >= 100); break;
        case 'atrisk': filtered = filtered.filter(e => e.achievementPct >= 80 && e.achievementPct < 100); break;
        case 'critical': filtered = filtered.filter(e => e.achievementPct < 80); break;
        case 'star': filtered = filtered.filter(e => e.achievementPct >= 110); break;
        case 'newjoiners': filtered = filtered.filter(e => e.isNewJoiner); break;
        case 'resigned': filtered = filtered.filter(e => e.isResigned); break;
      }

      const [key, dir] = sortBy.split('-');
      filtered.sort((a, b) => {
        let aVal, bVal;
        switch (key) {
          case 'name': aVal = a.name.toLowerCase(); bVal = b.name.toLowerCase(); break;
          case 'achievement': aVal = a.achievementPct; bVal = b.achievementPct; break;
          case 'output': aVal = a.totalDone; bVal = b.totalDone; break;
          case 'shortfall': aVal = a.shortfall; bVal = b.shortfall; break;
          default: aVal = a.name; bVal = b.name;
        }
        if (aVal < bVal) return dir === 'asc' ? -1 : 1;
        if (aVal > bVal) return dir === 'asc' ? 1 : -1;
        return 0;
      });

      return filtered;
    }

    function renderTable() {
      const employees = getFilteredAndSortedEmployees();
      const isYTD = appData.isYTD;

      if (isYTD) {
        // YTD table - simplified without daily cells
        document.getElementById('table-header').innerHTML = `
          <tr>
            <th class="px-4 py-3 text-left font-semibold border-b border-slate-700">Employee</th>
            <th class="px-3 py-3 text-center font-semibold border-b border-slate-700">Target</th>
            <th class="px-3 py-3 text-center font-semibold border-b border-slate-700">Months</th>
            <th class="px-3 py-3 text-center font-semibold border-b border-slate-700">Total Output</th>
            <th class="px-3 py-3 text-center font-semibold border-b border-slate-700">Target Req.</th>
            <th class="px-3 py-3 text-center font-semibold border-b border-slate-700">Shortfall</th>
            <th class="px-3 py-3 text-center font-semibold border-b border-slate-700">Achievement %</th>
          </tr>
        `;
        document.getElementById('table-body').innerHTML = employees.map((emp, idx) => `
          <tr class="hover:bg-slate-800 ${idx % 2 ? 'bg-slate-900/50' : ''}">
            <td class="px-4 py-2 border-b border-slate-700">
              <div class="flex items-center gap-2">
                <div>
                  <div class="font-medium">${emp.name}</div>
                  <div class="text-xs text-gray-500">(${emp.id})</div>
                </div>
                ${emp.isNewJoiner ? '<span class="px-2 py-0.5 bg-blue-600 rounded text-xs">ğŸ†•</span>' : ''}
                ${emp.isResigned ? '<span class="px-2 py-0.5 bg-orange-600 rounded text-xs">ğŸšª</span>' : ''}
              </div>
            </td>
            <td class="px-3 py-2 text-center border-b border-slate-700 font-bold">${emp.dailyTarget}</td>
            <td class="px-3 py-2 text-center border-b border-slate-700">${emp.months?.length || 0}</td>
            <td class="px-3 py-2 text-center font-bold border-b border-slate-700 text-cyan-400">${emp.totalDone}</td>
            <td class="px-3 py-2 text-center border-b border-slate-700">${emp.targetRequired}</td>
            <td class="px-3 py-2 text-center font-bold border-b border-slate-700 ${emp.shortfall > 0 ? 'text-red-400' : 'text-emerald-400'}">${emp.shortfall > 0 ? '-' + emp.shortfall : '0'}</td>
            <td class="px-3 py-2 text-center border-b border-slate-700">
              <span class="font-bold ${emp.achievementPct >= 100 ? 'text-emerald-400' : emp.achievementPct >= 80 ? 'text-amber-400' : 'text-red-400'}">${emp.achievementPct.toFixed(0)}%</span>
            </td>
          </tr>
        `).join('');
      } else {
        // MTD table with daily cells
        const dayHeaders = [];
        for (let d = appData.filterFromDay; d <= appData.filterToDay; d++) {
          const isNonWorking = isNonWorkingDay(appData.currentYear, appData.currentMonth, d);
          dayHeaders.push(`<th class="px-1 py-2 text-center font-semibold border-b border-slate-700 text-xs min-w-[28px] ${isNonWorking ? 'bg-slate-700' : ''}">${d}</th>`);
        }
        
        document.getElementById('table-header').innerHTML = `
          <tr>
            <th class="px-4 py-2 text-left font-semibold border-b border-slate-700 min-w-[180px]">Employee</th>
            <th class="px-2 py-2 text-center font-semibold border-b border-slate-700">T</th>
            <th class="px-2 py-2 text-center font-semibold border-b border-slate-700">â†•</th>
            ${dayHeaders.join('')}
            <th class="px-2 py-2 text-center font-semibold border-b border-slate-700">Done</th>
            <th class="px-2 py-2 text-center font-semibold border-b border-slate-700">Req</th>
            <th class="px-2 py-2 text-center font-semibold border-b border-slate-700">Gap</th>
            <th class="px-2 py-2 text-center font-semibold border-b border-slate-700">%</th>
          </tr>
        `;

        document.getElementById('table-body').innerHTML = employees.map((emp, idx) => {
          const dailyCells = [];
          for (let d = appData.filterFromDay; d <= appData.filterToDay; d++) {
            const day = emp.dailyData[d - 1];
            if (!day) continue;
            
            if (day.isNonWorking) {
              dailyCells.push(`<td class="px-1 py-1 text-center border-b border-slate-700"><div class="w-6 h-6 mx-auto rounded flex items-center justify-center text-xs font-bold text-gray-400 cell-holiday">H</div></td>`);
            } else if (d < emp.effectiveFromDay || d > emp.effectiveToDay) {
              dailyCells.push(`<td class="px-1 py-1 text-center border-b border-slate-700"><div class="w-6 h-6 mx-auto rounded flex items-center justify-center text-xs text-gray-600">-</div></td>`);
            } else {
              dailyCells.push(`<td class="px-1 py-1 text-center border-b border-slate-700" title="Day ${d}: R${day.retail} P${day.prolinks} S${day.svg}"><div class="w-6 h-6 mx-auto rounded flex items-center justify-center text-xs font-medium text-white ${getColorClass(day.total, emp.dailyTarget)}">${day.total}</div></td>`);
            }
          }

          return `
            <tr class="hover:bg-slate-800 ${idx % 2 ? 'bg-slate-900/50' : ''}">
              <td class="px-4 py-1 border-b border-slate-700">
                <div class="flex items-center gap-1">
                  <div class="min-w-0">
                    <div class="font-medium text-sm truncate">${emp.name}</div>
                    <div class="text-xs text-gray-500 flex items-center gap-1">
                      (${emp.id})
                      ${emp.isNewJoiner ? `<span class="px-1 py-0.5 bg-blue-600 rounded text-[10px]">ğŸ†• ${emp.joinerDate?.split('-')[2] || ''}</span>` : ''}
                      ${emp.isResigned ? `<span class="px-1 py-0.5 bg-orange-600 rounded text-[10px]">ğŸšª ${emp.resignedDate?.split('-')[2] || ''}</span>` : ''}
                    </div>
                  </div>
                  ${emp.alerts.map(a => `<span class="cursor-help" title="${a.message}">${a.icon}</span>`).join('')}
                </div>
              </td>
              <td class="px-2 py-1 text-center border-b border-slate-700 font-bold text-xs">${emp.dailyTarget}</td>
              <td class="px-2 py-1 text-center border-b border-slate-700 text-sm ${emp.trend === 'up' ? 'text-emerald-400' : emp.trend === 'down' ? 'text-red-400' : 'text-gray-400'}">${emp.trend === 'up' ? 'â†‘' : emp.trend === 'down' ? 'â†“' : 'â†’'}</td>
              ${dailyCells.join('')}
              <td class="px-2 py-1 text-center font-bold border-b border-slate-700 text-cyan-400 text-xs">${emp.totalDone}</td>
              <td class="px-2 py-1 text-center border-b border-slate-700 text-xs">${emp.targetRequired}</td>
              <td class="px-2 py-1 text-center font-bold border-b border-slate-700 text-xs ${emp.shortfall > 0 ? 'text-red-400' : 'text-emerald-400'}">${emp.shortfall > 0 ? '-' + emp.shortfall : '0'}</td>
              <td class="px-2 py-1 text-center border-b border-slate-700">
                <span class="font-bold text-xs ${emp.achievementPct >= 100 ? 'text-emerald-400' : emp.achievementPct >= 80 ? 'text-amber-400' : 'text-red-400'}">${emp.achievementPct.toFixed(0)}%</span>
              </td>
            </tr>
          `;
        }).join('');
      }
    }

    function getColorClass(total, target) {
      if (target === 10) {
        if (total >= 10) return 'cell-green';
        if (total >= 8) return 'cell-yellow';
        return 'cell-red';
      } else {
        if (total >= 8) return 'cell-green';
        if (total >= 6) return 'cell-yellow';
        return 'cell-red';
      }
    }

    function renderFooterStats() {
      const employees = appData.employees;
      const stats = appData.teamStats;
      
      document.getElementById('footer-stats').innerHTML = `
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
          <div class="font-semibold mb-3">ğŸ“Š Performance Distribution</div>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-emerald-400">â­ Exceeding (â‰¥110%)</span><span class="font-bold">${employees.filter(e => e.achievementPct >= 110).length}</span></div>
            <div class="flex justify-between"><span class="text-emerald-400">âœ… On Track (100-109%)</span><span class="font-bold">${employees.filter(e => e.achievementPct >= 100 && e.achievementPct < 110).length}</span></div>
            <div class="flex justify-between"><span class="text-amber-400">âš ï¸ At Risk (80-99%)</span><span class="font-bold">${employees.filter(e => e.achievementPct >= 80 && e.achievementPct < 100).length}</span></div>
            <div class="flex justify-between"><span class="text-red-400">ğŸ”´ Critical (&lt;80%)</span><span class="font-bold">${employees.filter(e => e.achievementPct < 80).length}</span></div>
          </div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
          <div class="font-semibold mb-3">ğŸ‘¥ Employee Status</div>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-gray-400">Total Employees</span><span class="font-bold">${stats.total}</span></div>
            <div class="flex justify-between"><span class="text-blue-400">ğŸ†• New Joiners</span><span class="font-bold">${stats.newJoinersCount}</span></div>
            <div class="flex justify-between"><span class="text-orange-400">ğŸšª Resigned</span><span class="font-bold">${stats.resignedCount}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Regular</span><span class="font-bold">${stats.total - stats.newJoinersCount - stats.resignedCount}</span></div>
          </div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
          <div class="font-semibold mb-3">ğŸ“ˆ Summary</div>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-gray-400">Working Days</span><span class="font-bold">${stats.workingDays}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Total Target</span><span class="font-bold">${stats.totalTarget?.toLocaleString() || 0}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Total Output</span><span class="font-bold text-cyan-400">${stats.totalOutput?.toLocaleString() || 0}</span></div>
            <div class="flex justify-between"><span class="text-gray-400">Overall Achievement</span><span class="font-bold ${stats.avgAchievement >= 100 ? 'text-emerald-400' : 'text-amber-400'}">${stats.avgAchievement?.toFixed(1) || 0}%</span></div>
          </div>
        </div>
      `;
    }

    // ==================== MODAL FUNCTIONS ====================
    function openModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      if (modalId === 'holiday-modal') renderHolidayList();
      if (modalId === 'joiner-modal') renderJoinerList();
      if (modalId === 'resigned-modal') renderResignedList();
      if (modalId === 'settings-modal') updateSettingsCounts();
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
      document.body.style.overflow = '';
      saveAllData();
      if (appData) renderDashboard();
    }

    // ==================== HOLIDAY MANAGEMENT ====================
    function renderHolidayList() {
      const year = document.getElementById('holiday-year-select').value;
      const yearHolidays = holidays.filter(h => h.date.startsWith(year));
      
      const container = document.getElementById('holiday-list');
      if (yearHolidays.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No holidays for ' + year + '</p>';
      } else {
        container.innerHTML = yearHolidays.map(h => {
          const date = new Date(h.date + 'T00:00:00');
          const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
          const formattedDate = date.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
          return `
            <div class="flex items-center justify-between p-2 bg-slate-800 rounded-lg group">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-slate-700 flex items-center justify-center text-xs font-bold text-cyan-400">${dayName}</div>
                <div>
                  <div class="font-medium text-sm">${h.name}</div>
                  <div class="text-xs text-gray-400">${formattedDate}</div>
                </div>
              </div>
              <button onclick="removeHoliday('${h.date}')" class="p-2 text-gray-500 hover:text-red-400 rounded-lg opacity-0 group-hover:opacity-100">ğŸ—‘ï¸</button>
            </div>
          `;
        }).join('');
      }
      document.getElementById('holiday-count').textContent = yearHolidays.length;
    }

    function addHoliday() {
      const date = document.getElementById('holiday-date').value;
      const name = document.getElementById('holiday-name').value.trim();
      if (!date || !name) return alert('Please enter both date and name');
      if (holidays.some(h => h.date === date)) return alert('Holiday already exists for this date');
      
      holidays.push({ date, name });
      holidays.sort((a, b) => a.date.localeCompare(b.date));
      saveAllData();
      
      document.getElementById('holiday-date').value = '';
      document.getElementById('holiday-name').value = '';
      renderHolidayList();
    }

    function removeHoliday(date) {
      holidays = holidays.filter(h => h.date !== date);
      saveAllData();
      renderHolidayList();
    }

    function clearAllHolidays() {
      const year = document.getElementById('holiday-year-select').value;
      if (confirm(`Clear all holidays for ${year}?`)) {
        holidays = holidays.filter(h => !h.date.startsWith(year));
        saveAllData();
        renderHolidayList();
      }
    }

    function bulkImportHolidays() {
      const input = document.getElementById('bulk-holiday-input').value.trim();
      if (!input) return;
      
      const lines = input.split('\n').filter(l => l.trim());
      let added = 0;
      
      lines.forEach(line => {
        const parts = line.split(',').map(p => p.trim());
        if (parts.length >= 2) {
          const date = parts[0];
          const name = parts.slice(1).join(', ');
          if (date.match(/^\d{4}-\d{2}-\d{2}$/) && !holidays.some(h => h.date === date)) {
            holidays.push({ date, name });
            added++;
          }
        }
      });
      
      holidays.sort((a, b) => a.date.localeCompare(b.date));
      saveAllData();
      document.getElementById('bulk-holiday-input').value = '';
      renderHolidayList();
      alert(`Imported ${added} holidays`);
    }

    // ==================== JOINER MANAGEMENT ====================
    function renderJoinerList() {
      const container = document.getElementById('joiner-list');
      const emptyMsg = document.getElementById('joiner-empty');
      
      if (newJoiners.length === 0) {
        container.innerHTML = '';
        emptyMsg.classList.remove('hidden');
      } else {
        emptyMsg.classList.add('hidden');
        container.innerHTML = newJoiners.map(j => {
          const date = new Date(j.date + 'T00:00:00');
          const formattedDate = date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
          return `
            <div class="flex items-center justify-between p-3 bg-slate-800 rounded-lg group">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-blue-600/30 flex items-center justify-center text-lg">ğŸ†•</div>
                <div>
                  <div class="font-medium text-sm">${j.name}</div>
                  <div class="text-xs text-gray-400">(${j.id}) â€¢ Joined: ${formattedDate}</div>
                </div>
              </div>
              <button onclick="removeJoiner('${j.id}')" class="p-2 text-gray-500 hover:text-red-400 rounded-lg opacity-0 group-hover:opacity-100">ğŸ—‘ï¸</button>
            </div>
          `;
        }).join('');
      }
      document.getElementById('joiner-count').textContent = newJoiners.length;
    }

    function addJoiner() {
      const name = document.getElementById('joiner-name').value.trim();
      let id = document.getElementById('joiner-id').value.trim().toUpperCase();
      const date = document.getElementById('joiner-date').value;
      
      if (!name || !id || !date) return alert('Please fill all fields');
      if (!id.startsWith('PR')) id = 'PR' + id.replace(/\D/g, '');
      if (newJoiners.some(j => j.id === id)) return alert('This employee is already in the list');
      
      newJoiners.push({ name, id, date });
      saveAllData();
      
      document.getElementById('joiner-name').value = '';
      document.getElementById('joiner-id').value = '';
      document.getElementById('joiner-date').value = '';
      renderJoinerList();
    }

    function removeJoiner(id) {
      newJoiners = newJoiners.filter(j => j.id !== id);
      saveAllData();
      renderJoinerList();
    }

    // ==================== RESIGNED MANAGEMENT ====================
    function renderResignedList() {
      const container = document.getElementById('resigned-list');
      const emptyMsg = document.getElementById('resigned-empty');
      
      if (resignedEmployees.length === 0) {
        container.innerHTML = '';
        emptyMsg.classList.remove('hidden');
      } else {
        emptyMsg.classList.add('hidden');
        container.innerHTML = resignedEmployees.map(r => {
          const date = new Date(r.date + 'T00:00:00');
          const formattedDate = date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
          return `
            <div class="flex items-center justify-between p-3 bg-slate-800 rounded-lg group">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-orange-600/30 flex items-center justify-center text-lg">ğŸšª</div>
                <div>
                  <div class="font-medium text-sm">${r.name}</div>
                  <div class="text-xs text-gray-400">(${r.id}) â€¢ Last day: ${formattedDate}</div>
                </div>
              </div>
              <button onclick="removeResigned('${r.id}')" class="p-2 text-gray-500 hover:text-red-400 rounded-lg opacity-0 group-hover:opacity-100">ğŸ—‘ï¸</button>
            </div>
          `;
        }).join('');
      }
      document.getElementById('resigned-count').textContent = resignedEmployees.length;
    }

    function addResigned() {
      const name = document.getElementById('resigned-name').value.trim();
      let id = document.getElementById('resigned-id').value.trim().toUpperCase();
      const date = document.getElementById('resigned-date').value;
      
      if (!name || !id || !date) return alert('Please fill all fields');
      if (!id.startsWith('PR')) id = 'PR' + id.replace(/\D/g, '');
      if (resignedEmployees.some(r => r.id === id)) return alert('This employee is already in the list');
      
      resignedEmployees.push({ name, id, date });
      saveAllData();
      
      document.getElementById('resigned-name').value = '';
      document.getElementById('resigned-id').value = '';
      document.getElementById('resigned-date').value = '';
      renderResignedList();
    }

    function removeResigned(id) {
      resignedEmployees = resignedEmployees.filter(r => r.id !== id);
      saveAllData();
      renderResignedList();
    }

    // ==================== SETTINGS IMPORT/EXPORT ====================
    function updateSettingsCounts() {
      document.getElementById('settings-holiday-count').textContent = holidays.length;
      document.getElementById('settings-joiner-count').textContent = newJoiners.length;
      document.getElementById('settings-resigned-count').textContent = resignedEmployees.length;
    }

    function exportSettings() {
      const data = {
        exportDate: new Date().toISOString(),
        version: '2.0',
        holidays,
        newJoiners,
        resignedEmployees
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tracker_settings_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      alert('Settings exported successfully! Share this file with your team.');
    }

    function importSettings(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          
          if (data.holidays) holidays = data.holidays;
          if (data.newJoiners) newJoiners = data.newJoiners;
          if (data.resignedEmployees) resignedEmployees = data.resignedEmployees;
          
          saveAllData();
          updateSettingsCounts();
          alert('Settings imported successfully!');
        } catch (error) {
          alert('Invalid settings file');
          console.error(error);
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    // ==================== DOWNLOAD REPORTS ====================
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape', 'mm', 'a4');
      
      const title = appData.isYTD ? 'YTD Performance Report' : 'MTD Performance Report';
      doc.setFontSize(18);
      doc.text(title, 14, 15);
      
      doc.setFontSize(10);
      doc.text(`Report Date: ${appData.dateRangeText}`, 14, 22);
      doc.text(`Working Days: ${appData.workingDays}`, 14, 27);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 32);
      
      const tableData = getFilteredAndSortedEmployees().map(emp => [
        emp.name,
        emp.id,
        emp.dailyTarget,
        emp.totalDone,
        emp.targetRequired,
        emp.shortfall > 0 ? -emp.shortfall : 0,
        emp.achievementPct.toFixed(1) + '%',
        emp.isNewJoiner ? 'New Joiner' : emp.isResigned ? 'Resigned' : 'Active'
      ]);
      
      doc.autoTable({
        startY: 38,
        head: [['Name', 'ID', 'Target', 'Done', 'Required', 'Shortfall', 'Achievement', 'Status']],
        body: tableData,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [6, 182, 212] }
      });
      
      // Summary
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(10);
      doc.text('Summary:', 14, finalY);
      doc.setFontSize(8);
      doc.text(`Total Employees: ${appData.teamStats.total}`, 14, finalY + 5);
      doc.text(`On Track: ${appData.teamStats.onTrack}`, 14, finalY + 10);
      doc.text(`Critical: ${appData.teamStats.critical}`, 14, finalY + 15);
      doc.text(`Avg Achievement: ${appData.teamStats.avgAchievement.toFixed(1)}%`, 14, finalY + 20);
      
      doc.save(`Performance_Report_${appData.dateRangeText.replace(/\s/g, '_')}.pdf`);
    }

    function downloadExcel() {
      const employees = getFilteredAndSortedEmployees();
      
      const data = employees.map(emp => ({
        'Employee Name': emp.name,
        'Employee ID': emp.id,
        'Daily Target': emp.dailyTarget,
        'Total Output': emp.totalDone,
        'Target Required': emp.targetRequired,
        'Shortfall': emp.shortfall > 0 ? -emp.shortfall : 0,
        'Achievement %': emp.achievementPct.toFixed(1),
        'Working Days': emp.workingDays,
        'Status': emp.isNewJoiner ? 'New Joiner' : emp.isResigned ? 'Resigned' : 'Active',
        'Trend': emp.trend
      }));
      
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Performance Report');
      
      // Add summary sheet
      const summaryData = [
        { Metric: 'Report Date', Value: appData.dateRangeText },
        { Metric: 'Working Days', Value: appData.workingDays },
        { Metric: 'Total Employees', Value: appData.teamStats.total },
        { Metric: 'On Track', Value: appData.teamStats.onTrack },
        { Metric: 'At Risk', Value: appData.teamStats.atRisk },
        { Metric: 'Critical', Value: appData.teamStats.critical },
        { Metric: 'New Joiners', Value: appData.teamStats.newJoinersCount },
        { Metric: 'Resigned', Value: appData.teamStats.resignedCount },
        { Metric: 'Total Output', Value: appData.teamStats.totalOutput },
        { Metric: 'Total Target', Value: appData.teamStats.totalTarget },
        { Metric: 'Avg Achievement %', Value: appData.teamStats.avgAchievement.toFixed(1) }
      ];
      const summaryWs = XLSX.utils.json_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
      
      XLSX.writeFile(wb, `Performance_Report_${appData.dateRangeText.replace(/\s/g, '_')}.xlsx`);
    }

    // ==================== UTILITY FUNCTIONS ====================
    function toggleTheme() {
      darkMode = !darkMode;
      document.body.classList.toggle('light-mode');
      document.body.classList.toggle('bg-slate-950', darkMode);
      document.body.classList.toggle('bg-gray-50', !darkMode);
      document.body.classList.toggle('text-gray-100', darkMode);
      document.body.classList.toggle('text-gray-900', !darkMode);
      document.getElementById('theme-toggle').textContent = darkMode ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }

    function resetApp() {
      appData = null;
      ytdFiles = [];
      searchTerm = '';
      filterStatus = 'all';
      sortBy = 'name-asc';
      dateFilter = { from: null, to: null };
      
      document.getElementById('search-input').value = '';
      document.getElementById('filter-select').value = 'all';
      document.getElementById('sort-select').value = 'name-asc';
      document.getElementById('date-from').value = '';
      document.getElementById('date-to').value = '';
      document.getElementById('ytd-files-list').classList.add('hidden');
      document.getElementById('process-ytd-btn').classList.add('hidden');
      document.getElementById('file-input').value = '';
      document.getElementById('ytd-file-input').value = '';
      
      document.getElementById('report-type-badge').textContent = 'MTD';
      document.getElementById('report-type-badge').className = 'px-3 py-1 rounded-full text-xs font-medium bg-cyan-900/50 text-cyan-400';
      
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('upload-screen').classList.remove('hidden');
      setReportMode('mtd');
    }
  </script>
</body>
</html>
